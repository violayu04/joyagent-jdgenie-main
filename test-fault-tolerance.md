# 容错性测试计划

## 测试目标
验证用户消息在发送后能够立即保存到会话历史中，即使后续的 AI 模型处理失败。

## 测试场景

### 1. 正常流程测试
- **操作**: 用户发送消息 "测试正常流程"
- **期望结果**: 
  - 用户消息立即保存到数据库
  - AI 成功处理并返回响应
  - 助手响应也保存到数据库

### 2. AI 处理失败测试
- **操作**: 
  1. 模拟网络故障或 AI 服务不可用
  2. 用户发送消息 "测试 AI 失败场景"
- **期望结果**:
  - 用户消息成功保存到数据库（关键！）
  - 前端显示 AI 处理失败的提示
  - 用户消息仍然出现在会话历史中

### 3. 数据库验证
- **操作**: 查询数据库中的聊天记录
- **期望结果**: 
  - 即使 AI 失败的情况下，用户消息仍存在于 `chat_messages` 表中
  - 消息的 role 为 "user"
  - 消息内容正确保存

## 关键改进点

### 后端改进
1. **新增 API**: `/web/api/v1/chat/saveUserMessage` - 专门用于立即保存用户消息
2. **解耦处理**: `AutoAgent` 方法不再负责保存用户消息，只处理 AI 响应
3. **自动保存助手响应**: `ChatSessionSSEPrinter` 自动收集和保存完整的 AI 响应

### 前端改进
1. **分离流程**: `sendMessage` 函数先调用 `saveUserMessage` API，再调用 AI 处理
2. **容错处理**: AI 处理失败时，用户消息已经安全保存
3. **用户反馈**: 清楚地告知用户消息保存状态

## 验证要点
- ✅ 用户消息保存与 AI 处理完全解耦
- ✅ 即使 AI 失败，用户消息也会持久化
- ✅ 错误处理不会影响已保存的消息
- ✅ 会话管理仍然正常工作